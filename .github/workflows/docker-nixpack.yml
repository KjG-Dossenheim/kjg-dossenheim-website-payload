name: Build Docker Nixpack

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install Nixpacks
        run: |
          curl -sSL https://nixpacks.com/install.sh | bash
          echo "$HOME/.nixpacks/bin" >> "$GITHUB_PATH"

      - name: Show Nixpacks version
        run: nixpacks --version

      - name: Build Docker image with Nixpacks
        env:
          IMAGE_NAME: kjg-dossenheim-website
          DATABASE_URI: ${{ secrets.DATABASE_URI }}
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}
          S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
          S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
        run: |
          nixpacks build . \
            --name "${IMAGE_NAME}" \
            --tag "${IMAGE_NAME}:nixpack-${{ github.sha }}" \
            --env DATABASE_URI \
            --env PAYLOAD_SECRET \
            --env S3_ACCESS_KEY_ID \
            --env S3_SECRET_ACCESS_KEY \
            --env CLOUDFLARE_ACCOUNT_ID \
            --env S3_BUCKET_NAME
